---
layout: null
---
<!doctype html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>Map, Food Oasis Los Angeles</title>
	
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Reem+Kufi|Open+Sans" />
	<link rel="stylesheet" href="/assets/css/oasis.css" />

	<!-- For Mapbox -->
	<link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.22.0/mapbox-gl.css" />

	<style>
	.map-filters {
		position: absolute;
		z-index: 1;
		top: 7.25rem; /* header height + 1.5rem */
		left: 1.5rem;
		width: 15em;
	}

	@media (min-width: 30em) {
		.map-filters {
			top: 8.75rem; /* header height + 3rem */
			left: 3rem;
		}
	}

	.map-filters .food-bank {
		background-color: rgb(249, 192, 88); /* @banana */
	}
	.map-filters .community-garden {
		background-color: rgb(144, 194, 70); /* @lime */
	}
	.map-filters .farmers-market {
		background-color: rgb(241, 95, 91); /* @strawberry */
	}
	.map-filters .grocery-store {
		background-color: rgb(77, 85, 148); /* @blueberry */
	}

	.map-filters .inactive {
		opacity: 0.5;
	}

	@media (max-width: 35em) and (max-height: 35em) {
		.map-filters {
			display: none;
		}
	}
	</style>
</head>
<body class="map">

	{% include header.html %}
	{% include find-food-link.html %}

	<nav class="search">
		<h1>Map of food near you</h1>
		<ul>
			<li class="map"><a>Map</a></li>
			<li class="list"><a href="/list">List</a></li>
		</ul>
	</nav>
	<script>
	(function() {
		// SHIM: Make the address persistent
		var searchLink = document.querySelector('.search a[href]');
		searchLink.setAttribute('href', searchLink.getAttribute('href') + window.location.search);
	})();
	</script>

	<nav class="map-filters"></nav>

	<div id="map" class="mapbox"></div>

	<!-- For map.js -->
	<script type="text/template" id="you-are-here-template">
		<div class="you-are-here"><span>You are here</span></div>
	</script>

	<script type="text/template" id="popup-template">
	<div class="map-point-details">
		<h3><a href=""></a></h3>
		<p class="type"></p>
		<p class="address"></p>
		<p class="phone"></p>
		<h4>Hours</h4>
		<p class="hours"></p>
	</div>
	</script>

	<!-- Jim’s Google Maps API key -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP5KxqO9v1sLhXlkrG3vDiDdOJvYLJ0H4"></script>

	<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js"></script>
	<script>

	var MAP_START_POSITION = [-118.243683, 34.052235];

	var MAP_BOUNDS = [
		[-119.9442369,32.7089729], // Southwest coordinates
		[-116.63282912,35.8275538]  // Northeast coordinates
	];

	var MAP_LAYERS = [
		{
			name: 'food-bank',
			label: 'Food Bank',
			sourceLayer: 'Food_Banks_-_Andrew',
			sourceURL: 'mapbox://fooddesertsla.c1nwj97w',
            // iconImage: '/assets/images/map/food-bank.svg',
			color: 'rgba(249, 192, 88, 0.75)' /* @banana */
		},
		{
			name: 'community-garden',
			label: 'Community Garden',
			sourceLayer: 'CG-UF-Nursery_-_Andrew',
			sourceURL: 'mapbox://fooddesertsla.5x93lfi1',
            // iconImage: '/assets/images/map/urban-farm.svg',
			color: 'rgba(144, 194, 70, 0.75)' /* @lime */
		},
		{
			name: 'farmers-market',
			label: 'Farmers Market',
			sourceLayer: 'Farmers_Markets_-_MASTER',
			sourceURL: 'mapbox://fooddesertsla.2ppvk6wg',
            // iconImage: '/assets/images/map/farmers-market.svg',
			color: 'rgba(241, 95, 91, 0.75)' /* @strawberry */
		}
		// ,
		// {
		// 	name: 'grocery-store',
		// 	label: 'Grocery Store',
		// 	sourceLayer: 'Grocery_Stores_and_Supermarkets_',
		// 	sourceURL: 'mapbox://fooddesertsla.3ow9v9cf',
		// 	// iconImage: '/assets/images/map/grocery-store.svg',
		// 	color: 'rgba(77, 85, 148, 0.35)' /* @blueberry */
		// }
	];

	function getLayerLabel(name) {
		for (var index = 0; index < MAP_LAYERS.length; index++) {
			if (MAP_LAYERS[index].name === name) {
				return MAP_LAYERS[index].label;
			}
		}
	}

	function geocodeAddress(address, callback) {
		var geocoder = new google.maps.Geocoder();

		geocoder.geocode({'address': address}, function(results, status) {
			if (status === google.maps.GeocoderStatus.OK) {

				var longitude = results[0].geometry.location.lng();
				var latitude  = results[0].geometry.location.lat();

				callback([longitude, latitude]);

			} else {
				console.error('Geocode was not successful for the following reason: ' + status);
			}
		});
	}

	// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144
	
	function getParameterByName(name, url) {
		if (!url) url = window.location.href;
		name = name.replace(/[\[\]]/g, "\\$&");
		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
		if (!results) return null;
		if (!results[2]) return '';
		return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

	function findUserLocation() {
		var address = getParameterByName('address');

		if (address) {

			// Add Los Angeles to the address
			if (address.indexOf('Los Angeles') < 0) {
				address += ' Los Angeles';
			}

			geocodeAddress(address, moveMapToPosition);

		// Grab user's location on page-load
		} else if ("geolocation" in navigator) {
			navigator.geolocation.getCurrentPosition(function(position) {

				// Set new starting location
				var myCoords = [position.coords.longitude, position.coords.latitude];
				moveMapToPosition(myCoords);
				console.log('current coords', myCoords);

			}, function() {
				console.error("Unable to retrieve your location");
			});
		}
	}

	function moveMapToPosition(position) {
		 map.setZoom(17);
		 map.panTo(position);

		// Add a marker at the user’s location
		// map.addSource('single-point', {
	 //        "type": "geojson",
	 //        "data": {
	 //            "type": "FeatureCollection",
	 //            "features": [{
		//             "type": "Feature",
	 //                "geometry": {
	 //                    "type": "Point",
	 //                    "coordinates": [position.coords.longitude, position.coords.latitude],
	 //                	}
	 //            }]
	 //        }
	 //    });

	 //    map.addLayer({
	 //        "id": "point",
	 //        "source": "single-point",
	 //        "type": "circle",
	 //        "paint": {
	 //            "circle-radius": 10,
	 //            "circle-color": "#007cbf"
	 //        }
	 //    });

		var template = document.getElementById('you-are-here-template');
		if (template) {
			var marker = document.createElement('div');
			marker.innerHTML = template.innerHTML;

			new mapboxgl.Marker(marker)
				.setLngLat(position)
				.addTo(map);
		}
	}

	var urlTag = getParameterByName('type');

	console.log(urlTag);

	var popup;
	function showPopup(event) {
		var layerNames = [];
		for (var i = 0; i < MAP_LAYERS.length; i++) {
			layerNames.push(MAP_LAYERS[i].name);
			layerNames.push(MAP_LAYERS[i].name + '-near');
			layerNames.push(MAP_LAYERS[i].name + '-far');
		}
		var features = map.queryRenderedFeatures(event.point, { 
			layers: layerNames
		});

		if (!popup) {
			popup = new mapboxgl.Popup({
				closeButton: false,
				closeOnClick: false
			});
		}

		// Change the cursor style as a UI indicator.
		map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
		if (!features.length) {
			popup.remove();
			return;
		}

		var feature = features[0];

		// TEMPORARY: Only show links to food banks (since the /source/ pages are only generated for food banks presently).
		var showLink = (feature.layer.id.indexOf('food-bank') >= 0 || feature.layer.id.indexOf('community-garden') >= 0 || feature.layer.id.indexOf('farmers-market') >= 0) ? true : false;

		var element = createPopupElement(feature, showLink);

		popup.setLngLat(feature.geometry.coordinates).setDOMContent(element).addTo(map);
	}

	function createPopupElement(feature, showLink) {

		var template = document.getElementById('popup-template');
		if (template) {
			var element = document.createElement('div');
			element.innerHTML = template.innerHTML;

			var data = getFeatureData(feature);

			// Name
			var nameElement = element.querySelector('h3');
			if (showLink) {
				var link = nameElement.querySelector('a');
				link.setAttribute('href', data.uri);
				link.innerText = data.name;
			} else {
				nameElement.innerText = data.name;
			}

			// Type
			var typeElement = element.querySelector('.type');
			typeElement.innerText = data.type;
			// typeElement.className += ' ' + type;

			// Address
			if (data.address) element.querySelector('.address').innerHTML = data.address;

			// Phone
			var phoneElement = element.querySelector('.phone');
			if (data.phone) phoneElement.innerText = data.phone;
			else {
				var phoneElement = element.querySelector('.phone');
				phoneElement.parentNode.removeChild(phoneElement)
			}

			// Hours
			var hoursElement = element.querySelector('.hours');
			if (data.hours) {
				hoursElement.innerHTML = data.hours;
			} else {
				var h4 = element.querySelector('h4');
				h4.parentNode.removeChild(h4);

				hoursElement.parentNode.removeChild(hoursElement);
			}

			return element;
		}
	}

	function getFeatureData(feature) {

		var data = {
			name:   feature.properties["name"] || 
					feature.properties["Name"] ||
					feature.properties["NAME"] ||
					feature.properties["NAME:"] ||
					feature.properties["MarketName"],
			type:   getLayerLabel(feature.layer.id.replace('-near', '').replace('-far', '')),
			hours:  feature.properties["times"] ||
					feature.properties["Times"] ||
					feature.properties["TIMES"] ||
					feature.properties["TIMES:"],
			phone:  feature.properties["telephone"] ||
					feature.properties["Telephone"] ||
					feature.properties["CONTACT"] ||
					feature.properties["CONTACT:"],
			address: getFeatureAddress(feature)
		};

		data.uri = '/' + 
					data.type.toLowerCase()
					.replace(/\s/g, '-') + '/' + 
					data.name.toLowerCase()
					.replace(/\s/g, '-')
					.replace(/\//g, '-')
					.replace(/\&/g, '-')
					.replace(/\./g, '-')
					.replace(/\'/g, '')
					.replace(/\-\-/g, '-');

		return data;
	}

	function getFeatureAddress(feature) {
		var address = "";

		var street = 
					feature.properties["address"] ||
					feature.properties["Address"] ||
					feature.properties["ADDRESS"] ||
					feature.properties["ADDRESS:"];
		var city = 
					feature.properties["city"] ||
					feature.properties["City"];
		var state = 
					feature.properties["state"] ||
					feature.properties["State"];

		if (street) 
				address += street;
		if (city)
				address += (street ? ', ' : '') + city;
		if (city && state)
				address += (city ? ', ' : (street ? ', ' : '')) + state;

		return address;
	}

	mapboxgl.accessToken = 'pk.eyJ1IjoiZm9vZGRlc2VydHNsYSIsImEiOiJjaXByOXRscnMwNzY1Zm5ub3YwYTd5Z3dsIn0.DWgUhgW32pVkybKx7cWWiw';
	var map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/mapbox/light-v9',
		zoom: 13, // starting zoom
		center: MAP_START_POSITION, // starting position
		maxBounds: MAP_BOUNDS
	});

	var nav = new mapboxgl.Navigation({position: 'bottom-left'}); // position is optional
	map.addControl(nav);

	// Add 'Current Location' Functionality
	map.addControl(new mapboxgl.Geolocate());

	map.on('click', showPopup); 

	function addLayer(data, markerSize, minzoom, maxzoom) {
		var name = data.name + (!minzoom ? '-far' : (!maxzoom ? '-near' : ''));
		console.log('id: ' + name);
		map.addSource(name, {
			type: 'vector',
			url: data.sourceURL
		});
		var layerData = {
			'id': name,
			'type': 'circle',
			'source': name,
			'layout': {
				'visibility': 'visible'
                // 'icon-image': data.iconImage
			},
			'paint': {
				'circle-radius': markerSize,
				'circle-color': data.color
			},
			'source-layer': data.sourceLayer
		};
		if (minzoom) layerData.minzoom = minzoom;
		if (maxzoom) layerData.maxzoom = maxzoom;
		map.addLayer(layerData);
	}

	map.on('load', function () {
		for (var index = 0; index < MAP_LAYERS.length; index++) {
			addLayer(MAP_LAYERS[index], 9, 14, null); // Zoomed in
			addLayer(MAP_LAYERS[index], 6, 12, 14);
			addLayer(MAP_LAYERS[index], 3, null, 12); // Zoomed out
		}

		/*
		map.addSource('Census Tracts', {
			type: 'vector',
			url: 'mapbox://fooddesertsla.26tf3nay'
		});
		map.addLayer({
			'id': 'Census Tracts',
			'type': 'line',
			'source': 'Census Tracts',
			'layout': {
				'visibility': 'visible',
				'line-join': 'round',
				'line-cap': 'round'
			},
			'paint': {
				'line-color': '#877b59',
				'line-width': 1
			},
			'source-layer': 'LI_LA_Desert_Map_-_USDA_-_Tracts'
		});

		map.addSource('Food Deserts', {
			type: 'vector',
			url: 'mapbox://fooddesertsla.26tf3nay'
		});
		map.addLayer({
			'id': 'Food Deserts',
			'type': 'fill',
			'source': 'Food Deserts',
			'layout': {
				'visibility': 'visible'
			},
			'paint': {
				'fill-color': '#877b59'
			},
			'filter': ["==", "LI LA De_4", "1"],
			'source-layer': 'LI_LA_Desert_Map_-_USDA_-_Tracts'
		});
		*/

		findUserLocation();

		//var toggleableLayerIds = [ 'Grocery Stores', 'Farmers Markets', 'Food Banks', 'Community Gardens', 'Census Tracts', 'Food Deserts'];

		var layers = document.querySelector('.map-filters');
		function createButton(data) {

			var button = document.createElement('button');
			button.type = "button";
			button.className = data.name;
			button.textContent = data.label + 's'; // SHIM: Pluralize

			button.addEventListener('click', function(e) {
				e.preventDefault();

				var visibility = map.getLayoutProperty(data.name, 'visibility');

				if (visibility === 'visible') {
					map.setLayoutProperty(data.name, 'visibility', 'none');
					map.setLayoutProperty(data.name + '-near', 'visibility', 'none');
					map.setLayoutProperty(data.name + '-far', 'visibility', 'none');
					this.className += ' inactive';
				} else {
					map.setLayoutProperty(data.name, 'visibility', 'visible');
					map.setLayoutProperty(data.name + '-near', 'visibility', 'visible');
					map.setLayoutProperty(data.name + '-far', 'visibility', 'visible');
					this.className = this.className.replace(/inactive/g, '');
				}
			}, false);

			layers.appendChild(button);
		}

		for (var i = 0; i < MAP_LAYERS.length; i++) {
			createButton(MAP_LAYERS[i]);
		}
	});

	</script>

</body>
</html>
