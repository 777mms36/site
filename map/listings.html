---
layout: null
---
<!doctype html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	

	<title>Map, Food Oasis Los Angeles</title>
	
	<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
	<link rel="stylesheet" href="/assets/css/oasis.css" />
	

	<!-- For Mapbox -->
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
	<link rel="stylesheet" href="listings.css" />

</head>
<body>
	{% include header.html %}
	{% include find-food-link.html %}

	<div class='sidebar'>
		<div class='heading'>
			<h1>All Locations</h1>
		</div>

		<div id='listings' class='listings'></div>
	</div>

	<ul class="filters">
		<li><button onclick="foodBankFilter()" id="fb-filter">Food Banks</button></li>
		<li><button onclick="communityGardenFilter()" id="cg-filter">Community Gardens</button></li>
		<li><button onclick="farmersMarketFilter()" id="fm-filter">Farmers’ Markets</button></li>
	</ul>

	<!--<ul class="filters">
		<button onclick="foodBankFilter()"><li id="fb-filter"><a href="?type=food-banks">Food Banks</a></li></button>
		<li id="cg-filter"><a href="?type=community-gardens">Community Gardens</a></li>
		<li id="fm-filter"><a href="?type=farmers-markets">Farmers’ Markets</a></li>
	</ul>-->

	<div id='map' class='map'></div>

		<script type="text/template" id="you-are-here-template">
			<div class="you-are-here"><span>You are here</span></div>
		</script>

	<script>
		// This will let you use the .remove() function later on
		if (!('remove' in Element.prototype)) {
			Element.prototype.remove = function() {
				if (this.parentNode) {
					this.parentNode.removeChild(this);
				}
			};
		}

		mapboxgl.accessToken = 'pk.eyJ1IjoiZm9vZGRlc2VydHNsYSIsImEiOiJjaXByOXRscnMwNzY1Zm5ub3YwYTd5Z3dsIn0.DWgUhgW32pVkybKx7cWWiw';
		// This adds the map to your page
		var map = new mapboxgl.Map({
		  container: 'map',
		  style: 'mapbox://styles/mapbox/light-v9',
		  center: [-118.243683, 34.052235],
		  zoom: 14
		});

		// Add 'Current Location' functionality
		map.addControl(new mapboxgl.Geolocate());
		
		// Add map navigational functionality
		map.addControl(new mapboxgl.Navigation({position: 'bottom-left'}));


		// Link to mapbox tilesets
		// map.addSource('Food Bank', {
		// 	type: 'vector',
		// 	url: 'mapbox://fooddesertsla.c1nwj97w'
		// });

//		var foodbanks = 

		var stores =

		{
			"type": "FeatureCollection",
			"features": [

			{% for food_source in site.data['food_banks_andrew'] %}
			  {
			    "type": "Feature",
			    "geometry": {
			      "type": "Point",
			      "coordinates": [
			       	{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
			      ]
			    },
			    "properties": {
						"name": "{{ food_source['name'] }}",
			      "phone": "{{ food_source['phone'] }}",
			      "address": "{{ food_source['address'] }}",
						"hours": "{{ food_source['hours'] }}",
						"type": "foodBank"
			    }
			  },
				{% endfor %}
			
			{% for food_source in site.data['community_gardens_andrew'] %}
			  {
			    "type": "Feature",
			    "geometry": {
			      "type": "Point",
			      "coordinates": [
			       	{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
			      ]
			    },

			    "properties": {
						"name": "{{ food_source['name'] }}",
			     "address": "{{ food_source['address'] | line_returns_to_html }}",
						"type": "communityGarden"
			    }
			  },
				{% endfor %}
			
			{% for food_source in site.data['farmers_markets_andrew'] %}
			  {
			    "type": "Feature",
			    "geometry": {
			      "type": "Point",
			      "coordinates": [
			       	{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
			      ]
			    },

			    "properties": {
						"name": "{{ food_source['name'] }}",
			     "address": "{{ food_source['address'] }}",
						"type": "farmersMarket"
			    }
			  },
				{% endfor %}
			],

		}

		function buildLocationList(data) {
			// Iterate through the list of stores
			for (i = 0; i < data.features.length; i++) {
				var currentFeature = data.features[i];
				// Shorten data.feature.properties to just `prop` so we're not
			// writing this long form over and over again.
				var prop = currentFeature.properties;
				// Select the listing container in the HTML and append a div
			// with the class 'item' for each store
				var listings = document.getElementById('listings');
				var listing = listings.appendChild(document.createElement('div'));
				listing.className = 'item';
				listing.id = "listing-" + i;

				// Create a new link with the class 'title' for each store
				// and fill it with the store address
				var link = listing.appendChild(document.createElement('a'));
					link.href = '#';
					link.className = 'title';
					link.dataPosition = i;
					link.innerHTML = prop.name;
				
				// Create a new div with the class 'details' for each store
				// and fill it with the city and phone number

				var locationAddress = listing.appendChild(document.createElement('div'));
				locationAddress.innerHTML = prop.address;

				// Create a new div with the class 'details' for each store
				// and fill it with the city and phone number
				var details = listing.appendChild(document.createElement('div'));
				details.innerHTML = "Phone: " + prop.phone + ' &middot ' + "Hours: " + prop.hours;

				if (prop.phone) {
			  		details.innerHTML += ' &middot; ' + prop.phoneFormatted;
				}

				// Add an event listener for the links in the sidebar listing
				link.addEventListener('click', function(e){
					// Update the currentFeature to the store associated with the clicked link
					var clickedListing = data.features[this.dataPosition];
					// 1. Fly to the point associated with the clicked link
					flyToStore(clickedListing);
					// 2. Close all other popups and display popup for clicked store
					createPopUp(clickedListing);
					// 3. Highlight listing in sidebar (and remove highlight for all other listings)
					var activeItem = document.getElementsByClassName('active');
						if (activeItem[0]) {
						 activeItem[0].classList.remove('active');
					}

					this.parentNode.classList.add('active');
				});
			}
		}
							//FILTERING FUNCTIONALITY //

	function foodBankFilter() {
		console.log('inside food bank filter');
		var fb = document.getElementsByClassName("food-bank-marker");
		fb.style.visibility = "hidden";
	}

	function farmersMarketFilter() {
		console.log('inside farmers market filter');
		document.getElementsByClassName("farmers-market-marker").style.visibility = "hidden";
	}

	function communityGardenFilter() {
		console.log('inside community garden filter');
		document.getElementsByClassName("community-garden-marker").style.visibility = "hidden";
	}

							// END FILTERING FUNCTIONALITY //


								// USER'S GEOLOCATION //

	// function geocodeAddress(address, callback) {
	// 	var geocoder = new google.maps.Geocoder();

	// 	geocoder.geocode({'address': address}, function(results, status) {
	// 		if (status === google.maps.GeocoderStatus.OK) {

	// 			var longitude = results[0].geometry.location.lng();
	// 			var latitude  = results[0].geometry.location.lat();

	// 			callback([longitude, latitude]);

	// 		} else {
	// 			console.error('Geocode was not successful for the following reason: ' + status);
	// 		}
	// 	});
	// }

	// // http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144
	
	// function getParameterByName(name, url) {
	// 	if (!url) url = window.location.href;
	// 	name = name.replace(/[\[\]]/g, "\\$&");
	// 	var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
	// 			results = regex.exec(url);
	// 	if (!results) return null;
	// 	if (!results[2]) return '';
	// 	return decodeURIComponent(results[2].replace(/\+/g, " "));
	// }

	// function findUserLocation() {
	// 	var address = getParameterByName('address');

	// 	if (address) {

	// 		// Add Los Angeles to the address
	// 		if (address.indexOf('Los Angeles') < 0) {
	// 			address += ' Los Angeles';
	// 		}

	// 		geocodeAddress(address, moveMapToPosition);

	// 	// Grab user's location on page-load
	// 	} else if ("geolocation" in navigator) {
	// 		navigator.geolocation.getCurrentPosition(function(position) {

	// 			// Set new starting location
	// 			var myCoords = [position.coords.longitude, position.coords.latitude];
	// 			moveMapToPosition(myCoords);

	// 		}, function() {
	// 			console.error("Unable to retrieve your location");
	// 		});
	// 	}
	// }

	// function moveMapToPosition(position) {
	// 	 map.setZoom(20);
	// 	 map.panTo(position);

	// 	// Add a marker at the user’s location
	// 	// map.addSource('single-point', {
	//  //        "type": "geojson",
	//  //        "data": {
	//  //            "type": "FeatureCollection",
	//  //            "features": [{
	// 	//             "type": "Feature",
	//  //                "geometry": {
	//  //                    "type": "Point",
	//  //                    "coordinates": [position.coords.longitude, position.coords.latitude],
	//  //                	}
	//  //            }]
	//  //        }
	//  //    });

	//  //    map.addLayer({
	//  //        "id": "point",
	//  //        "source": "single-point",
	//  //        "type": "circle",
	//  //        "paint": {
	//  //            "circle-radius": 10,
	//  //            "circle-color": "#007cbf"
	//  //        }
	//  //    });

	// var template = document.getElementById('you-are-here-template');
	// 	if (template) {
	// 		var marker = document.createElement('div');
	// 		marker.innerHTML = template.innerHTML;

	// 		new mapboxgl.Marker(marker)
	// 			.setLngLat(position)
	// 			.addTo(map);
	// 	}
	// }

    					// END USER'S GEOLOCATION //

		function flyToStore(currentFeature) {
			map.flyTo({
				center: currentFeature.geometry.coordinates,
				zoom: 15
			});
		}

		function createPopUp(currentFeature) {
			var popUps = document.getElementsByClassName('mapboxgl-popup');
			// Check if there is already a popup on the map and if so, remove it
			if (popUps[0]) popUps[0].remove();
			var markerType = currentFeature.properties.type;

			var popup = new mapboxgl.Popup()
				.setLngLat(currentFeature.geometry.coordinates)
				.setHTML('<h3 id=' + markerType + '>' + currentFeature.properties.name + '</h3>' + 
					'<h4>' + "Address: " + currentFeature.properties.address + '<br />' + "Phone: " + currentFeature.properties.phone 
					+ '<br />' + "Hours: " + currentFeature.properties.hours + '<br />' + "Open Now!" + '</h4>')
				.addTo(map);
		}

		map.on('load', function (e) {
			// Add the stores data as a source
			map.addSource("places", {
				"type": "geojson",
				"data": stores
			});

			// Add a layer to the map with styling rules to render the source
			// map.addLayer({
			// 	"id": "locations",
			// 	"type": "symbol",
			// 	"source": "places",
			// 	"layout": {
			// 		"icon-image": "restaurant-15",
			// 		"icon-allow-overlap": true,
			// 	}
			// });

			// Initialize the list
			buildLocationList(stores);

		});

		// Add an event listener for when a user clicks on the map
		map.on('click', function (e) {
			// Query all the rendered points in the view
			var features = map.queryRenderedFeatures(e.point, { layers: ['locations'] });
			if (features.length) {
				var clickedPoint = features[0];
				// 1. Fly to the point
				flyToStore(clickedPoint);
				// 2. Close all other popups and display popup for clicked store
				createPopUp(clickedPoint);
				// 3. Highlight listing in sidebar (and remove highlight for all other listings)
				var activeItem = document.getElementsByClassName('active');
				
				if (activeItem[0]) {
					activeItem[0].classList.remove('active');
				}
				
				// Find the index of the store.features that corresponds to the clickedPoint that fired the event listener
				var selectedFeature = clickedPoint.properties.address;
				  
				for (var i = 0; i < stores.features.length; i++ ) {
					if (stores.features[i].properties.address === selectedFeature) {
					    selectedFeatureIndex = i;
					}
				}
				// Select the correct list item using the found index and add the active class
				var listing = document.getElementById('listing-' + selectedFeatureIndex);
				listing.classList.add('active');
			}
		});

		stores.features.forEach(function(marker) {
			// Create a div element for the marker
			var el = document.createElement('div');
			// Add a class called 'marker' to each div
			if(marker.properties.type === "foodBank") {
				el.className = 'food-bank-marker'
			} else if (marker.properties.type === "farmersMarket") {
				el.className = 'farmers-market-marker'
			} else if (marker.properties.type === "communityGarden") {
				el.className = 'community-garden-marker'
			}

			// By default the image for your custom marker will be anchored
			// by its top left corner. Adjust the position accordingly
			el.style.left='-28px';
			el.style.top='-46px';

			// Create the custom markers, set their position, and add to map
			new mapboxgl.Marker(el)
				.setLngLat(marker.geometry.coordinates)
				.addTo(map);

			el.addEventListener('click', function(e) {
				var activeItem = document.getElementsByClassName('active');

				// 1. Fly to the point
				flyToStore(marker);
				// 2. Close all other popups and display popup for clicked store
				createPopUp(marker);
				// 3. Highlight listing in sidebar (and remove highlight for all other listings)
				e.stopPropagation();

				if (activeItem[0]) {
					activeItem[0].classList.remove('active');
				}

				var listing = document.getElementById('listing-' + i);
	
				listing.classList.add('active');
			});
	// findUserLocation();
		});

	</script>

</body>
</html>
