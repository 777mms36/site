---
layout: null
---
<!doctype html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8" >
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<title>Map, Food Oasis Los Angeles</title>
	
	<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
	<link rel="stylesheet" href="/assets/css/oasis.css" />

	<!-- For Mapbox -->
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />

	<link rel="stylesheet" href="/assets/css/map-listings.css" />

</head>
<body>
	{% include header.html %}
	{% include link-to-find-food.html %}

	<div class='sidebar'>
		<div class='heading' style="position: absolute; left: -9999px">
			<h1>All Locations</h1>
		</div>

		<div id='listings' class='listings'></div>
	</div>

	<ul class="filters">
		<li><button onclick="foodBankFilter()" id="fb-filter">Food Banks</button></li>
		<li><button onclick="communityGardenFilter()" id="cg-filter">Community Gardens</button></li>
		<li><button onclick="farmersMarketFilter()" id="fm-filter">Farmers’ Markets</button></li>
		<li><button onclick="supermarketFilter()" id="fm-filter">Supermarkets</button></li>
	</ul>

	<!--<ul class="filters">
		<button onclick="foodBankFilter()"><li id="fb-filter"><a href="?type=food-banks">Food Banks</a></li></button>
		<li id="cg-filter"><a href="?type=community-gardens">Community Gardens</a></li>
		<li id="fm-filter"><a href="?type=farmers-markets">Farmers’ Markets</a></li>
	</ul>-->

	<div id='map' class='map'></div>

		<script type="text/template" id="you-are-here-template">
			<div class="you-are-here"><span>You are here</span></div>
		</script>

	<script type="text/template" id="popup-template">
	<div class="map-point-details">
		<h3><a href=""></a></h3>
		<p class="type"></p>
		<p class="address"></p>
		<p class="phone"></p>
		<h4>Hours</h4>
		<p class="hours"></p>
	</div>
	</script>


	<!-- Jim’s Google Maps API key -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBP5KxqO9v1sLhXlkrG3vDiDdOJvYLJ0H4"></script>
	<script>
		// This will let you use the .remove() function later on
		if (!('remove' in Element.prototype)) {
			Element.prototype.remove = function() {
				if (this.parentNode) {
					this.parentNode.removeChild(this);
				}
			};
		}

		mapboxgl.accessToken = 'pk.eyJ1IjoiZm9vZG9hc2lzbGEiLCJhIjoiY2l0ZjdudnN4MDhpYzJvbXlpb3IyOHg2OSJ9.POBdqXF5EIsGwfEzCm8Y3Q';
		// This adds the map to your page
		var map = new mapboxgl.Map({
		  container: 'map',
		  style: 'mapbox://styles/mapbox/light-v9',
		  center: [-118.243683, 34.052235],
		  zoom: 14
		});

		// Add 'Current Location' functionality
		map.addControl(new mapboxgl.Geolocate());
		
		// Add map navigational functionality
		map.addControl(new mapboxgl.Navigation({position: 'bottom-left'}));


		// Link to mapbox tilesets
		// map.addSource('Food Bank', {
		// 	type: 'vector',
		// 	url: 'mapbox://fooddesertsla.c1nwj97w'
		// });

//		var foodbanks = 

		var stores =

		{
			"type": "FeatureCollection",
			"features": [

			{% for food_source in site.data['food-banks'] %}
			  {
				"type": "Feature",
				"geometry": {
				  "type": "Point",
				  "coordinates": [
					{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
				  ]
				},
				"properties": {
						"name": "{{ food_source['name'] }}",
				  //"phone": "{{ food_source['phone'] }}",
				  "address": "{{ food_source['address'] }}",
						//"hours": "{{ food_source['hours'] }}",
						"type": "food-bank"
				}
			  },
				{% endfor %}

// TBD: These are throwing errors so disable for now
{% if false %}
			{% for food_source in site.data['community-gardens'] %}
			  {
				"type": "Feature",
				"geometry": {
				  "type": "Point",
				  "coordinates": [
					{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
				  ]
				},

				"properties": {
						"name": "{{ food_source['name'] }}",
				 "address": "{{ food_source['address'] | line_returns_to_html }}",
						"type": "community-garden"
				}
			  },
				{% endfor %}
			
			{% for food_source in site.data['farmers-markets'] %}
			  {
				"type": "Feature",
				"geometry": {
				  "type": "Point",
				  "coordinates": [
					{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
				  ]
				},

				"properties": {
						"name": "{{ food_source['name'] }}",
				 "address": "{{ food_source['address'] }}",
						"type": "farmers-market"
				}
			  },
				{% endfor %}
			
			{% for food_source in site.data['supermarkets'] %}
			  {
				"type": "Feature",
				"geometry": {
				  "type": "Point",
				  "coordinates": [
					{{ food_source['longitude'] }},
							 {{ food_source['latitude'] }}
				  ]
				},

				"properties": {
						"name": "{{ food_source['name'] }}",
				 "address": "{{ food_source['StreetAddress'] }}",
						"type": "supermarket"
				}
			  },
				{% endfor %}
{% endif %}

			],

		}

		function buildLocationList(data) {
			// Iterate through the list of stores
			for (i = 0; i < data.features.length; i++) {
				var currentFeature = data.features[i];
				// Shorten data.feature.properties to just `prop` so we're not
			// writing this long form over and over again.
				var prop = currentFeature.properties;
				// Select the listing container in the HTML and append a div
			// with the class 'item' for each store
				var listings = document.getElementById('listings');
				var listing = listings.appendChild(document.createElement('div'));
				listing.className = 'item';
				listing.id = "listing-" + i;

				// Create a new link with the class 'title' for each store
				// and fill it with the store address
				var link = listing.appendChild(document.createElement('a'));
					link.href = '#';
					link.className = 'title';
					link.dataPosition = i;
					link.innerHTML = prop.name;
				
				// Create a new div with the class 'details' for each store
				// and fill it with the city and phone number

				var locationAddress = listing.appendChild(document.createElement('div'));
				locationAddress.innerHTML = prop.address;

				// Create a new div with the class 'details' for each store
				// and fill it with the city and phone number
				var details = listing.appendChild(document.createElement('div'));
				var detailsHTML = "";
				if (prop.phone) detailsHTML += "Phone: " + prop.phone;
				if (prop.hours) detailsHTML += (prop.phone ? ' &middot ' : '') + "Hours: " + prop.hours;
				details.innerHTML = detailsHTML;

				// Add an event listener for the links in the sidebar listing
				link.addEventListener('click', function(e){
					// Update the currentFeature to the store associated with the clicked link
					var clickedListing = data.features[this.dataPosition];
					// 1. Fly to the point associated with the clicked link
					flyToStore(clickedListing);
					// 2. Close all other popups and display popup for clicked store
					showPopup(clickedListing);
					// 3. Highlight listing in sidebar (and remove highlight for all other listings)
					var activeItem = document.getElementsByClassName('active-listing-item');
						if (activeItem[0]) {
						 activeItem[0].classList.remove('active-listing-item');
					}

					this.parentNode.classList.add('active-listing-item');
				});
			}
		}
							//FILTERING FUNCTIONALITY //
	var fbClicked = true; 
	function foodBankFilter() {
		var fb = document.getElementsByClassName("food-bank-marker")
		if(fbClicked === true) {
			for(var i = 0; i < fb.length; i++) {
				fb[i].style.visibility = "hidden";
			}
			fbClicked = false; 
		} else {
			for(var i = 0; i < fb.length; i++) {
				fb[i].style.visibility = "visible";
			fbClicked = true;
			}
		}
	}

	var fmClicked = true; 
	function farmersMarketFilter() {
		var fm = document.getElementsByClassName("farmers-market-marker");
		if(fmClicked === true) {
			for(var i = 0; i < fm.length; i++) {
				fm[i].style.visibility = "hidden";
			}
			fmClicked = false;
		} else {
			for(var i = 0; i < fm.length; i++) {
				fm[i].style.visibility = "visible";
			}
			fmClicked = true;
		}
	}

	var cgClicked = true; 
	function communityGardenFilter() {
		var cm = document.getElementsByClassName("community-garden-marker");
		if(cgClicked === true){
			for(var i = 0; i < cm.length; i++) {
				cm[i].style.visibility = "hidden";
			}
			cgClicked = false;
		} else {
			for(var i = 0; i < cm.length; i++) {
				cm[i].style.visibility = "visible";
			}
			cgClicked = true;
		}
	}

	var smClicked = true; 
	function supermarketFilter() {
		var sm = document.getElementsByClassName("supermarket-marker");
		if(sgClicked === true){
			for(var i = 0; i < sm.length; i++) {
				sm[i].style.visibility = "hidden";
			}
			sgClicked = false;
		} else {
			for(var i = 0; i < sm.length; i++) {
				sm[i].style.visibility = "visible";
			}
			sgClicked = true;
		}
	}

							// END FILTERING FUNCTIONALITY //


								// USER'S GEOLOCATION //

		function geocodeAddress(address, callback) {
			var geocoder = new google.maps.Geocoder();

			geocoder.geocode({'address': address}, function(results, status) {
				if (status === google.maps.GeocoderStatus.OK) {

					var longitude = results[0].geometry.location.lng();
					var latitude  = results[0].geometry.location.lat();

					callback([longitude, latitude]);

				} else {
					console.error('Geocode was not successful for the following reason: ' + status);
				}
			});
		}

		// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript#answer-901144
		
		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
					results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}

		function findUserLocation() {
			var address = getParameterByName('address');

			if (address) {

				// Add Los Angeles to the address
				if (address.indexOf('Los Angeles') < 0) {
					address += ' Los Angeles';
				}

				geocodeAddress(address, moveMapToPosition);

			// Grab user's location on page-load
			} else if ("geolocation" in navigator) {
				navigator.geolocation.getCurrentPosition(function(position) {

					// Set new starting location
					var myCoords = [position.coords.longitude, position.coords.latitude];
					moveMapToPosition(myCoords);

				}, function() {
					console.error("Unable to retrieve your location");
				});
			}
		}

		function moveMapToPosition(position) {
			 map.setZoom(14);
			 map.panTo(position);

			var template = document.getElementById('you-are-here-template');
			if (template) {
				var marker = document.createElement('div');
				marker.innerHTML = template.innerHTML;

				new mapboxgl.Marker(marker)
					.setLngLat(position)
					.addTo(map);
			}
		}

						// END USER'S GEOLOCATION //

		function flyToStore(currentFeature) {
			map.flyTo({
				center: currentFeature.geometry.coordinates,
				zoom: 15
			});
		}

		var popup;
		function showPopup(feature) {
			//var popUps = document.getElementsByClassName('mapboxgl-popup');
			// Check if there is already a popup on the map and if so, remove it
			//if (popUps[0]) popUps[0].remove();

			if (!popup) {
				popup = new mapboxgl.Popup({
					closeButton: false,
					closeOnClick: false
				});
			}

			//var markerType = currentFeature.properties.type;

			/*
			var popup = new mapboxgl.Popup()
				.setLngLat(currentFeature.geometry.coordinates)
				.setHTML('<h3 id=' + markerType + '>' + currentFeature.properties.name + '</h3>' + 
					'<h4>' + "Address: " + currentFeature.properties.address + '<br />' + "Phone: " + currentFeature.properties.phone 
					+ '<br />' + "Hours: " + currentFeature.properties.hours + '<br />' + "Open Now!" + '</h4>')
				.addTo(map);
			*/

			var element = createPopupElement(feature);

			popup.setLngLat(feature.geometry.coordinates).setDOMContent(element).addTo(map);
		}

		function createPopupElement(feature) {

			var template = document.getElementById('popup-template');
			if (template) {
				var element = document.createElement('div');
				element.innerHTML = template.innerHTML;

				var data = getFeatureData(feature);

				// Container
				var container = element.querySelector('.map-point-details');
				container.className += ' ' + feature.properties.type; 

				// Name
				var nameElement = element.querySelector('h3');
				var link = nameElement.querySelector('a');
				link.setAttribute('href', data.uri);
				link.innerText = data.name;

				// Type
				var typeElement = element.querySelector('.type');
				typeElement.innerText = data.formattedType;
				// typeElement.className += ' ' + type;

				// Address
				if (data.address) element.querySelector('.address').innerHTML = data.formattedAddress;

				// Phone
				var phoneElement = element.querySelector('.phone');
				if (data.phone) phoneElement.innerText = data.phone;
				else {
					var phoneElement = element.querySelector('.phone');
					phoneElement.parentNode.removeChild(phoneElement)
				}

				// Hours
				var hoursElement = element.querySelector('.hours');
				if (data.hours) {
					hoursElement.innerHTML = data.hours;
				} else {
					var h4 = element.querySelector('h4');
					h4.parentNode.removeChild(h4);

					hoursElement.parentNode.removeChild(hoursElement);
				}

				return element;
			}
		}

		function getFeatureData(feature) {
			var data = feature.properties;
			data.formattedAddress = getFormattedAddress(feature);
			data.formattedType = getFormattedType(feature);

			data.uri = '/' + data.type.toLowerCase().replace(/\s/g, '-') + '/' + data.name.toLowerCase()
						.replace(/\s/g, '-')
						.replace(/\//g, '-')
						.replace(/\&/g, '-')
						.replace(/\./g, '-')
						.replace(/\'/g, '')
						.replace(/\-\-/g, '-');

			return data;
		}

		// KUDOS: http://alvinalexander.com/javascript/how-to-capitalize-each-word-javascript-string
		function capitalizeEachWord(str) {
			return str.replace(/\w\S*/g, function(txt) {
				return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
			});
		}

		function getFormattedType(feature) {
			return capitalizeEachWord(feature.properties.type.replace('-', ' '));
		}

		function getFormattedAddress(feature) {
			var address = "";

			var street = feature.properties["address"];
			var city   = feature.properties["city"];
			var state  = feature.properties["state"];

			if (street)        address += street;
			if (city)          address += (street ? ', ' : '') + city;
			if (city && state) address += (city ? ', ' : (street ? ', ' : '')) + state;

			return address;
		}

		map.on('load', function (e) {
			// Add the stores data as a source
			map.addSource("places", {
				"type": "geojson",
				"data": stores
			});

			// Add a layer to the map with styling rules to render the source
			// map.addLayer({
			// 	"id": "locations",
			// 	"type": "symbol",
			// 	"source": "places",
			// 	"layout": {
			// 		"icon-image": "restaurant-15",
			// 		"icon-allow-overlap": true,
			// 	}
			// });

			// Initialize the list
			buildLocationList(stores);

		});

		// Add an event listener for when a user clicks on the map
		/*
		map.on('click', function (e) {
			// Query all the rendered points in the view
			var features = map.queryRenderedFeatures(e.point, { layers: ['locations'] });
			if (features.length) {
				var clickedPoint = features[0];
				// 1. Fly to the point
				flyToStore(clickedPoint);
				// 2. Close all other popups and display popup for clicked store
				showPopup(clickedPoint);
				// 3. Highlight listing in sidebar (and remove highlight for all other listings)
				var activeItem = document.getElementsByClassName('active-listing-item');
				
				if (activeItem[0]) {
					activeItem[0].classList.remove('active-listing-item');
				}
				
				// Find the index of the store.features that corresponds to the clickedPoint that fired the event listener
				for (var i = 0; i < stores.features.length; i++ ) {
					if (stores.features[i].properties.name === clickedPoint.properties.name) {
						selectedFeatureIndex = i;
					}
				}
				// Select the correct list item using the found index and add the active class
				var listing = document.getElementById('listing-' + selectedFeatureIndex);
				listing.classList.add('active-listing-item');
			}
		});
		*/

		stores.features.forEach(function(marker) {
			// Create a div element for the marker
			var el = document.createElement('div');
			// Add a class called 'marker' to each div
			if(marker.properties.type === "food-bank") {
				el.className = 'food-bank-marker'
			} else if (marker.properties.type === "farmers-market") {
				el.className = 'farmers-market-marker'
			} else if (marker.properties.type === "community-garden") {
				el.className = 'community-garden-marker'
			} else if (marker.properties.type === "supermarket") {
				el.className = 'supermarket-marker'
			}

			// By default the image for your custom marker will be anchored
			// by its top left corner. Adjust the position accordingly
			el.style.left='-21px';  // Marker width / 2
			el.style.top='-56px'; // Marker height

			// Create the custom markers, set their position, and add to map
			new mapboxgl.Marker(el)
				.setLngLat(marker.geometry.coordinates)
				.addTo(map);

			el.addEventListener('click', function(e) {
				var activeItem = document.getElementsByClassName('active-listing-item');

				// 1. Fly to the point
				// flyToStore(marker);
				// 2. Close all other popups and display popup for clicked store
				showPopup(marker);
				// 3. Highlight listing in sidebar (and remove highlight for all other listings)
				//e.stopPropagation();

				if (activeItem[0]) {
					activeItem[0].classList.remove('active-listing-item');
				}

				//var listing = document.getElementById('listing-' + i);
	
				//listing.classList.add('active-listing-item');
			});
		});

		findUserLocation();
	</script>

</body>
</html>
